<!-- 
  Sidebar Component for EEPrep
  
  Contains:
  - Logo and site title
  - Main navigation links
  - Theme toggle
  - Sidebar collapse functionality
  
  This component is loaded dynamically by componentLoader.js
-->
<div class="sidebar-inner">
    <!-- Sidebar Header: Contains logo, title and close button -->
    <div class="sidebar-header">
        <div class="logo-container">
            <div class="modern-logo">
                <img src="Config/Assets/images/eeprep.png" alt="EE Prep Logo">
            </div>
            <h2 class="sidebar-title">EE Prep</h2>
        </div>
        
        <!-- Add toggle button in header -->
        <button id="sidebar-toggle" class="sidebar-toggle" aria-label="Toggle sidebar" title="Collapse Sidebar">
            <i class="fas fa-chevron-left"></i>
        </button>
        
        <button class="sidebar-close hidden-desktop" aria-label="Close menu">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- Main Navigation Links -->
    <nav class="sidebar-nav">
        <ul class="sidebar-menu">
            <li class="sidebar-item">
            <a href="index.html" class="sidebar-link" title="Home">
                <i class="fas fa-home"></i>
                <span class="link-text">Home</span>
            </a>
            </li>
            <li class="sidebar-item dropdown">
                <div class="sidebar-link-container">
                    <a href="../../Topics.html" class="sidebar-link" title="Topics">
                        <i class="fas fa-book"></i>
                        <span class="link-text">Topics</span>
                    </a>
                    <button class="dropdown-toggle-btn" title="Expand Topics" id="topics-toggle">
                        <i class="fas fa-chevron-down dropdown-icon"></i>
                    </button>
                </div>
                <div class="dropdown-menu" id="topics-dropdown-menu">
                    <!-- Topics will be loaded dynamically -->
                    <div class="dropdown-item loading">
                        <span>Loading topics...</span>
                    </div>
                </div>
            </li>

            <script>
                // Debug: Log current path context
                console.log('Current page URL:', window.location.href);
                console.log('Current path:', window.location.pathname);
                
                // Improved topics loading with better debugging and fallbacks
                (function() {
                    // Get the dropdown menu element
                    const dropdownMenu = document.getElementById('topics-dropdown-menu');
                    const toggleBtn = document.getElementById('topics-toggle');
                    
                    if (!dropdownMenu) {
                        console.error('Topics dropdown menu element not found!');
                        return;
                    }
                    
                    // Show loading indicator
                    dropdownMenu.innerHTML = '<div class="dropdown-item loading"><span>Loading topics...</span></div>';
                    
                    // Function to toggle dropdown visibility
                    function toggleDropdown() {
                        const isActive = dropdownMenu.classList.contains('active');
                        dropdownMenu.classList.toggle('active');
                        
                        // Update icon
                        if (toggleBtn) {
                            const icon = toggleBtn.querySelector('.dropdown-icon');
                            if (icon) {
                                icon.className = isActive ? 
                                    'fas fa-chevron-down dropdown-icon' : 
                                    'fas fa-chevron-up dropdown-icon';
                            }
                        }
                    }
                    
                    // Attach click handler to toggle button
                    if (toggleBtn) {
                        toggleBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            toggleDropdown();
                        });
                    }
                    
                    // Hardcoded fallback data in case JSON loading fails
                    const fallbackTopics = [
                        { name: "Circuits", path: "Topics/Circuits/index.html" },
                        { name: "Digital", path: "Topics/Digital/index.html" },
                        { name: "Electronics", path: "Topics/Electronics/index.html" },
                        { name: "Programming", path: "Topics/Programming/index.html" }
                    ];
                    
                    // Function to populate topics in dropdown
                    function populateTopics(topics) {
                        // Clear loading message
                        dropdownMenu.innerHTML = '';
                        
                        if (!Array.isArray(topics) || topics.length === 0) {
                            dropdownMenu.innerHTML = '<div class="dropdown-item"><span>No topics available</span></div>';
                            return;
                        }
                        
                        // Sort topics alphabetically
                        topics.sort((a, b) => a.name.localeCompare(b.name));
                        
                        // Add each topic
                        topics.forEach(topic => {
                            const listItem = document.createElement('div');
                            listItem.className = 'dropdown-item';
                            
                            const link = document.createElement('a');
                            link.href = topic.path;
                            link.className = 'dropdown-link';
                            link.textContent = topic.name;
                            
                            listItem.appendChild(link);
                            dropdownMenu.appendChild(listItem);
                            
                            console.log('Added topic:', topic.name, 'with path:', topic.path);
                        });
                    }
                    
                    // Try to load from multiple sources with better error reporting
                    let jsonLoaded = false;
                    
                    // Absolute path attempts starting from the domain root
                    const pathsToTry = [
                        '/Topics/pages.json',
                        'Topics/pages.json',
                        '../Topics/pages.json',
                        '../../Topics/pages.json',
                        '../../../Topics/pages.json',
                        window.location.origin + '/Topics/pages.json'
                    ];
                    
                    // Load pages.json with better error handling
                    function tryLoadJSON(index) {
                        if (jsonLoaded || index >= pathsToTry.length) {
                            if (!jsonLoaded) {
                                console.warn('All paths failed, using fallback data');
                                populateTopics(fallbackTopics);
                                
                                // Add message about using fallback data
                                const fallbackMsg = document.createElement('div');
                                fallbackMsg.className = 'dropdown-item notice';
                                fallbackMsg.innerHTML = '<small>Using fallback data - JSON loading failed</small>';
                                dropdownMenu.appendChild(fallbackMsg);
                            }
                            return;
                        }
                        
                        const path = pathsToTry[index];
                        console.log(`Trying to load topics from: ${path}`);
                        
                        fetch(path, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                                'Cache-Control': 'no-cache'
                            },
                            cache: 'no-store'
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error ${response.status}`);
                            }
                            console.log(`Successfully fetched from ${path}:`, response);
                            return response.text(); // Get as text first to inspect
                        })
                        .then(text => {
                            console.log(`Raw JSON data from ${path}:`, text);
                            try {
                                const data = JSON.parse(text);
                                if (Array.isArray(data)) {
                                    console.log('Parsed JSON data:', data);
                                    jsonLoaded = true;
                                    populateTopics(data);
                                } else {
                                    console.error('JSON is not an array:', data);
                                    tryLoadJSON(index + 1);
                                }
                            } catch (parseError) {
                                console.error('JSON parse error:', parseError, 'for text:', text);
                                tryLoadJSON(index + 1);
                            }
                        })
                        .catch(error => {
                            console.warn(`Failed to load from ${path}:`, error);
                            // Try next path after a short delay
                            setTimeout(() => tryLoadJSON(index + 1), 100);
                        });
                    }
                    
                    // Start trying to load JSON
                    tryLoadJSON(0);
                    
                    // Force dropdown to be visible when clicking link directly
                    const topicsLink = document.querySelector('.sidebar-item.dropdown .sidebar-link');
                    if (topicsLink) {
                        topicsLink.addEventListener('click', function(e) {
                            // If dropdown isn't active, prevent navigation and show dropdown
                            if (!dropdownMenu.classList.contains('active')) {
                                e.preventDefault();
                                toggleDropdown();
                            }
                        });
                    }
                    
                    // Make sure dropdown menu is properly styled
                    // Apply these styles directly to ensure visibility
                    if (dropdownMenu) {
                        // Ensure dropdown has proper CSS for visibility
                        dropdownMenu.style.transition = 'all 0.3s ease';
                        
                        // Make dropdown active state more explicit
                        const style = document.createElement('style');
                        style.textContent = `
                            .dropdown-menu.active {
                                display: block !important;
                                opacity: 1 !important;
                                visibility: visible !important;
                                max-height: 500px !important;
                                overflow-y: auto !important;
                            }
                        `;
                        document.head.appendChild(style);
                    }
                })();
            </script>
        </ul>
    </nav>
    
    <!-- Sidebar Footer: Contains theme toggle, sidebar toggle and info text -->
    <div class="sidebar-footer">
        <button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark mode" title="Toggle Theme">
            <i class="fas fa-moon"></i>
            <span class="link-text">Toggle Theme</span>
        </button>
        
        <div class="sidebar-info">
            <small><i>For the aspiring engineer</i></small>
        </div>
    </div>
</div>

<!-- Remove this duplicate button -->
<!-- <button id="sidebar-collapse-toggle" class="sidebar-collapse-toggle" aria-label="Toggle sidebar" title="Collapse Sidebar">
    <i class="fas fa-chevron-left"></i>
</button> -->

<script>
    /**
     * Sidebar functionality script
     * Handles sidebar close button and toggle functionality
     */
    
    // Sidebar close button (mobile)
    const closeButton = document.querySelector('.sidebar-close');
    if (closeButton) {
        closeButton.addEventListener('click', () => {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            if (sidebar) sidebar.classList.remove('active');
            if (overlay) overlay.classList.remove('active');
            document.body.classList.remove('sidebar-open');
            
            // Find and update the mobile toggle button icon
            const mobileToggle = document.querySelector('.mobile-nav-toggle');
            if (mobileToggle && mobileToggle.querySelector('i')) {
                mobileToggle.querySelector('i').className = 'fas fa-bars';
            }
            
            // Restore body scrolling when sidebar is closed
            document.body.style.overflow = '';
        });
    }
    
    // Improved sidebar collapse toggle functionality
    const sidebarCollapseToggle = document.getElementById('sidebar-toggle');
    if (sidebarCollapseToggle) {
        sidebarCollapseToggle.addEventListener('click', () => {
            // Add animation classes for smooth transition
            document.querySelector('.sidebar').classList.add('sidebar-animating');
            document.querySelector('.main-content').classList.add('content-animating');
            
            // Toggle collapsed state
            document.body.classList.toggle('sidebar-collapsed');
            
            // Update icon based on current state
            const isCollapsed = document.body.classList.contains('sidebar-collapsed');
            sidebarCollapseToggle.querySelector('i').className = isCollapsed ? 
                'fas fa-chevron-right' : 'fas fa-chevron-left';
                
            // Save state to localStorage
            localStorage.setItem('sidebar-collapsed', isCollapsed);
            
            // Remove animation class after transition completes
            setTimeout(() => {
                document.querySelector('.sidebar').classList.remove('sidebar-animating');
                document.querySelector('.main-content').classList.remove('content-animating');
            }, 300);
        });
    }
    
    // Handle dropdowns in the sidebar
    document.addEventListener('DOMContentLoaded', () => {
        // Function to open/close dropdown - defined outside event handlers
        function toggleDropdown(button) {
            // Find parent li element which contains both the button and dropdown menu
            const dropdownItem = button.closest('.sidebar-item.dropdown');
            if (!dropdownItem) return;
            
            // Find the dropdown menu within this item
            const dropdownMenu = dropdownItem.querySelector('.dropdown-menu');
            if (!dropdownMenu) return;
            
            // Toggle the active class
            dropdownMenu.classList.toggle('active');
            
            // Update the dropdown icon
            const icon = button.querySelector('.dropdown-icon');
            if (icon) {
                icon.className = dropdownMenu.classList.contains('active') 
                    ? 'fas fa-chevron-up dropdown-icon' 
                    : 'fas fa-chevron-down dropdown-icon';
            }
        }
        
        const dropdownButtons = document.querySelectorAll('.sidebar-item.dropdown .dropdown-toggle-btn');
        
        dropdownButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                // Check if sidebar is collapsed, expand it first if needed
                const isSidebarCollapsed = document.body.classList.contains('sidebar-collapsed');
                if (isSidebarCollapsed) {
                    // Expand sidebar first
                    document.body.classList.remove('sidebar-collapsed');
                    
                    // Update toggle button icon
                    const sidebarToggle = document.getElementById('sidebar-toggle');
                    if (sidebarToggle) {
                        sidebarToggle.querySelector('i').className = 'fas fa-chevron-left';
                    }
                    
                    // Save state to localStorage
                    localStorage.setItem('sidebar-collapsed', false);
                    
                    // Add a small delay before opening dropdown to allow sidebar animation to complete
                    setTimeout(() => {
                        toggleDropdown(button);
                    }, 300);
                } else {
                    // Sidebar already expanded, open dropdown immediately
                    toggleDropdown(button);
                }
            });
        });
        
        // Prevent dropdown menus from closing when clicking inside them
        const dropdownMenus = document.querySelectorAll('.sidebar .dropdown-menu');
        dropdownMenus.forEach(menu => {
            menu.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        });
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            // Only proceed if we're not clicking on a dropdown-toggle-btn
            if (!e.target.closest('.dropdown-toggle-btn')) {
                document.querySelectorAll('.sidebar .dropdown-menu.active').forEach(menu => {
                    menu.classList.remove('active');
                    
                    // Find the associated toggle button and update its icon
                    const dropdownItem = menu.closest('.sidebar-item.dropdown');
                    if (dropdownItem) {
                        const button = dropdownItem.querySelector('.dropdown-toggle-btn');
                        if (button) {
                            const icon = button.querySelector('.dropdown-icon');
                            if (icon) icon.className = 'fas fa-chevron-down dropdown-icon';
                        }
                    }
                });
            }
        });
    });
    
    // IMPROVED: Hide sidebar collapse toggle on mobile
    function updateCollapseToggleVisibility() {
        if (window.innerWidth <= 1024 && sidebarCollapseToggle) {
            sidebarCollapseToggle.style.display = 'none';
        } else if (sidebarCollapseToggle) {
            sidebarCollapseToggle.style.display = 'flex';
        }
    }
    
    // Run on load
    updateCollapseToggleVisibility();
    
    // Run on window resize
    window.addEventListener('resize', updateCollapseToggleVisibility);
    
    // IMPROVED: Mark current page in sidebar
    function highlightCurrentPage() {
        const currentPath = window.location.pathname;
        const links = document.querySelectorAll('.sidebar-link');
        
        links.forEach(link => {
            const href = link.getAttribute('href');
            if (href) {
                // Get the filename part from both URLs
                const currentFile = currentPath.split('/').pop().toLowerCase();
                const linkFile = href.split('/').pop().toLowerCase();
                
                // Mark as active if files match or if we're on homepage
                if (currentFile === linkFile || 
                    (currentFile === '' && linkFile === 'index.html')) {
                    link.parentElement.classList.add('active');
                }
            }
        });
    }
    
    // Run highlight on load
    highlightCurrentPage();
    
        // Add swipe gesture support for mobile
    document.addEventListener('DOMContentLoaded', function() {
        const sidebar = document.querySelector('.sidebar');
        const content = document.querySelector('.main-content');
        const overlay = document.querySelector('.sidebar-overlay');
        
        let touchStartX = 0;
        let touchEndX = 0;
        
        // Handle swipe open (right to left)
        content.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        }, {passive: true});
        
        content.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipeGesture();
        }, {passive: true});
        
        // Function to handle swipe gestures
        function handleSwipeGesture() {
            const threshold = 100; // Minimum swipe distance
            
            // Right to left swipe (open sidebar)
            if (touchStartX - touchEndX > threshold) {
                sidebar.classList.add('active');
                if (overlay) overlay.classList.add('active');
                document.body.classList.add('sidebar-open');
            }
            
            // Left to right swipe (close sidebar)
            if (touchEndX - touchStartX > threshold && sidebar.classList.contains('active')) {
                sidebar.classList.add('animating-out');
                
                setTimeout(() => {
                    sidebar.classList.remove('active');
                    sidebar.classList.remove('animating-out');
                    if (overlay) overlay.classList.remove('active');
                    document.body.classList.remove('sidebar-open');
                }, 300);
            }
        }
    });
    
    // Update mobile menu toggle functionality
    const mobileToggle = document.querySelector('.mobile-nav-toggle');
    if (mobileToggle) {
        mobileToggle.addEventListener('click', () => {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            const mainContent = document.querySelector('.main-content');
            
            if (sidebar) {
                if (sidebar.classList.contains('active')) {
                    // Close sidebar with animation
                    sidebar.classList.add('animating-out');
                    
                    setTimeout(() => {
                        sidebar.classList.remove('active');
                        sidebar.classList.remove('animating-out');
                        if (overlay) overlay.classList.remove('active');
                        document.body.classList.remove('sidebar-open');
                        
                        // Update toggle icon
                        const icon = mobileToggle.querySelector('i');
                        if (icon) icon.className = 'fas fa-bars';
                    }, 300);
                } else {
                    // Open sidebar with animation
                    sidebar.classList.add('animating-in');
                    sidebar.classList.add('active');
                    
                    // Position overlay properly next to the sidebar
                    if (overlay && mainContent) {
                        overlay.style.width = mainContent.offsetWidth + 'px';
                        overlay.classList.add('active');
                    }
                    
                    document.body.classList.add('sidebar-open');
                    
                    // Update toggle icon
                    const icon = mobileToggle.querySelector('i');
                    if (icon) icon.className = 'fas fa-times';
                    
                    // Clean up animation classes
                    setTimeout(() => {
                        sidebar.classList.remove('animating-in');
                    }, 300);
                }
            }
        });
    }
</script>
