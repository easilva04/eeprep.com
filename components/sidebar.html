<div class="sidebar">
    <div class="sidebar-content">
        <ul id="sidebar-menu">
            <!-- Menu items will be dynamically generated -->
        </ul>
    </div>
    <div class="sidebar-footer">
        <button id="dark-mode-toggle" class="theme-toggle">Dark Mode</button>
        <p>For the aspiring Engineer</p>
    </div>
</div>

<script src="js/themeToggle.js"></script>
<script>
    async function loadSidebar() {
        try {
            const response = await fetch('/Topics/pages.json');
            if (!response.ok) throw new Error('Network response was not ok');
            const pages = await response.json();
            console.log('Sidebar pages data:', pages);
            const sidebarMenu = document.getElementById('sidebar-menu');

            for (const section in pages) {
                const sectionItem = document.createElement('li');
                const sectionLink = document.createElement('a');
                sectionLink.href = '#';
                sectionLink.className = 'dropdown-toggle';
                sectionLink.textContent = section;
                sectionItem.appendChild(sectionLink);

                const dropdownMenu = document.createElement('ul');
                dropdownMenu.className = 'dropdown-menu';

                if (Array.isArray(pages[section])) {
                    if (pages[section].length > 0) {
                        pages[section].forEach(page => {
                            const pageItem = document.createElement('li');
                            const pageLink = document.createElement('a');
                            const pageTitle = page.title || (page.snippet ? page.snippet.slice(0,30) + '...' : 'Untitled');
                            const pageURL = page.url || '#';
                            pageLink.href = pageURL;
                            pageLink.textContent = pageTitle;
                            pageItem.appendChild(pageLink);
                            dropdownMenu.appendChild(pageItem);
                        });
                    } else {
                        // Show message if the array is empty
                        const emptyItem = document.createElement('li');
                        emptyItem.textContent = 'No content available';
                        dropdownMenu.appendChild(emptyItem);
                    }
                } else if (typeof pages[section] === 'object') {
                    let hasSubContent = false;
                    for (const subSection in pages[section]) {
                        hasSubContent = true;
                        const subSectionItem = document.createElement('li');
                        const subSectionLink = document.createElement('a');
                        subSectionLink.href = '#';
                        subSectionLink.className = 'dropdown-toggle';
                        subSectionLink.textContent = subSection;
                        subSectionItem.appendChild(subSectionLink);

                        const subDropdownMenu = document.createElement('ul');
                        subDropdownMenu.className = 'dropdown-menu';

                        if (Array.isArray(pages[section][subSection]) && pages[section][subSection].length > 0) {
                            pages[section][subSection].forEach(page => {
                                const pageItem = document.createElement('li');
                                const pageLink = document.createElement('a');
                                const pageTitle = page.title || (page.snippet ? page.snippet.slice(0,30) + '...' : 'Untitled');
                                const pageURL = page.url || '#';
                                pageLink.href = pageURL;
                                pageLink.textContent = pageTitle;
                                pageItem.appendChild(pageLink);
                                subDropdownMenu.appendChild(pageItem);
                            });
                        } else {
                            const emptySub = document.createElement('li');
                            emptySub.textContent = 'No content available';
                            subDropdownMenu.appendChild(emptySub);
                        }
                        subSectionItem.appendChild(subDropdownMenu);
                        dropdownMenu.appendChild(subSectionItem);
                    }
                    if (!hasSubContent) {
                        const emptyItem = document.createElement('li');
                        emptyItem.textContent = 'No content available';
                        dropdownMenu.appendChild(emptyItem);
                    }
                } else {
                    const pageItem = document.createElement('li');
                    const pageLink = document.createElement('a');
                    const pageTitle = pages[section].title || (pages[section].snippet ? pages[section].snippet.slice(0,30) + '...' : 'Untitled');
                    const pageURL = pages[section].url || '#';
                    pageLink.href = pageURL;
                    pageLink.textContent = pageTitle;
                    pageItem.appendChild(pageLink);
                    dropdownMenu.appendChild(pageItem);
                }

                sectionItem.appendChild(dropdownMenu);
                sidebarMenu.appendChild(sectionItem);
            }
        } catch (error) {
            console.error('Failed to load sidebar:', error);
            const sidebarMenu = document.getElementById('sidebar-menu');
            sidebarMenu.innerHTML = '<li>Error loading sidebar content. Please try refreshing the page.</li>';
        }
    }

    function applyTheme(theme) {
        document.body.classList.toggle('dark-mode', theme === 'dark');
    }

    function loadTheme() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);
    }

    function toggleTheme() {
        const currentTheme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        applyTheme(newTheme);
        localStorage.setItem('theme', newTheme);
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadSidebar().then(() => {
            document.querySelectorAll('.dropdown-toggle').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const submenu = this.nextElementSibling;
                    if (submenu) {
                        submenu.classList.toggle('active'); // Changed from "open" to "active"
                    }
                });
            });
        });
        loadTheme();

        const themeToggle = document.getElementById('dark-mode-toggle');
        themeToggle.addEventListener('click', toggleTheme);
    });
</script>
